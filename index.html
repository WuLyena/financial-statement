<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Analisis Keuangan Pro</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- External Libraries (CDN) -->
    <!-- XLSX for Excel handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- docxtemplater for Word export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.1/docxtemplater.js"></script>

    <style>
        /* CSS Reset and Base Styles (Sesuai dengan file asli) */
        :root {
            --bg-light: #f8f9fa;
            --text-light: #212529;
            --card-bg-light: #ffffff;
            --border-light: #dee2e6;
            --primary-color: #0d6efd;
            --primary-hover: #0b5ed7;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --green-bg: #e9f7ef;
            --green-text: #198754;
            --red-bg: #fdeeee;
            --red-text: #dc3545;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --font-family: 'Inter', sans-serif;
        }

        .dark-mode {
            --bg-light: #121212;
            --text-light: #e0e0e0;
            --card-bg-light: #1e1e1e;
            --border-light: #444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        /* Layout and Containers */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--card-bg-light);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .logo i {
            margin-right: 8px;
        }

        nav button,
        .theme-switch {
            background: none;
            border: none;
            color: var(--text-light);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 1rem;
            font-family: var(--font-family);
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
        }

        nav button.active {
            background-color: var(--primary-color);
            color: white;
        }

        nav button:not(.active):hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .dark-mode nav button:not(.active):hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .theme-switch {
            font-size: 1.2rem;
        }

        main {
            padding-top: 20px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        /* Collapsible Sections */
        .section {
            background-color: var(--card-bg-light);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .section-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
        }

        .section-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .section-content {
            padding: 1.5rem;
            display: grid;
            gap: 20px;
        }

        .section-header .chevron {
            transition: transform 0.3s;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .section.collapsed .chevron {
            transform: rotate(-90deg);
        }

        /* Form Elements & Buttons */
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background-color: var(--bg-light);
            color: var(--text-light);
            font-family: var(--font-family);
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #212529;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            max-height: 500px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border: 1px solid var(--border-light);
        }

        thead {
            position: sticky;
            top: 0;
            background-color: var(--card-bg-light);
            z-index: 10;
        }

        th {
            font-weight: 600;
        }

        tbody tr:nth-child(even) {
            background-color: var(--bg-light);
        }

        .dark-mode tbody tr:nth-child(even) {
            background-color: #2a2a2a;
        }

        td input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            background-color: transparent;
            color: var(--text-light);
            text-align: right;
        }

        td input:focus {
            background-color: var(--bg-light);
            border-color: var(--primary-color);
            outline: none;
        }

        td.error-cell {
            background-color: var(--red-bg) !important;
        }

        td.error-cell input {
            color: var(--red-text) !important;
        }

        .total-row {
            font-weight: bold;
            background-color: var(--bg-light);
        }

        .dark-mode .total-row {
            background-color: #2a2a2a;
        }

        .balance-error-row td {
            background-color: var(--red-bg);
            color: var(--red-text);
            font-weight: bold;
        }

        /* Ratio Table */
        .ratio-good {
            color: var(--green-text);
            background-color: var(--green-bg);
        }

        .ratio-bad {
            color: var(--red-text);
            background-color: var(--red-bg);
        }

        .ratio-neutral {
            color: var(--text-light);
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background-color: var(--card-bg-light);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .chart-container h3 {
            margin-bottom: 15px;
        }

        /* Analysis Tab */
        #analysis-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background-color: var(--bg-light);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .summary-card h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .summary-card p {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .summary-card .trend {
            margin-left: 8px;
        }

        .trend-up {
            color: var(--success-color);
        }

        .trend-down {
            color: var(--danger-color);
        }

        #narrative-editor {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background-color: var(--bg-light);
            color: var(--text-light);
            font-family: var(--font-family);
            resize: vertical;
        }

        /* Notifications */
        #notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            min-width: 300px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.info {
            background-color: var(--info-color);
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.warning {
            background-color: #212529;
            color: var(--warning-color);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal-content {
            background-color: var(--card-bg-light);
            margin: 10% auto;
            padding: 30px;
            border: 1px solid var(--border-light);
            width: 80%;
            max-width: 800px;
            border-radius: 12px;
            position: relative;
            animation: modalOpen 0.4s;
        }

        .modal-close {
            color: var(--secondary-color);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-bottom: 20px;
        }

        .modal-content p,
        .modal-content li {
            margin-bottom: 10px;
        }

        /* Spinner */
        #spinner {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .loader {
            border: 8px solid var(--bg-light);
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -30px;
            margin-left: -30px;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
                display: none;
            }
        }

        @keyframes modalOpen {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 10px;
            }

            nav {
                width: 100%;
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 20% auto;
            }
        }
    </style>
</head>

<body>

    <!-- Header and Navigation -->
    <header>
        <div class="logo"><i class="fa-solid fa-chart-pie"></i> Analis Keuangan</div>
        <nav>
            <button id="nav-input" class="active" data-tab="input-tab"><i class="fa-solid fa-keyboard"></i> Input
                Data</button>
            <button id="nav-dashboard" data-tab="dashboard-tab"><i class="fa-solid fa-tachometer-alt"></i>
                Dashboard</button>
            <button id="nav-analysis" data-tab="analysis-tab"><i class="fa-solid fa-pen-to-square"></i>
                Analisis</button>
            <button id="nav-help" data-tab="help-modal"><i class="fa-solid fa-circle-question"></i> Bantuan</button>
        </nav>
        <button class="theme-switch" id="theme-toggle" aria-label="Toggle dark mode">
            <i class="fa-solid fa-moon"></i>
        </button>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Input Data Tab -->
        <section id="input-tab" class="tab-content active">
            <!-- Settings Section -->
            <div class="section" id="settings-section">
                <div class="section-header">
                    <h2><i class="fa-solid fa-gear"></i> Pengaturan</h2>
                    <i class="fa-solid fa-chevron-down chevron"></i>
                </div>
                <div class="section-content" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="form-group">
                        <label for="start-year">Tahun Awal</label>
                        <input type="number" id="start-year" min="1900" max="2100">
                    </div>
                    <div class="form-group">
                        <label for="num-years">Jumlah Tahun</label>
                        <input type="number" id="num-years" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label for="industry-select">Industri</label>
                        <select id="industry-select"></select>
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                        <button id="apply-settings" class="btn btn-primary"><i class="fa-solid fa-check"></i> Terapkan</button>
                    </div>
                </div>
            </div>
            <!-- Data Management Section -->
            <div class="section" id="data-management-section">
                <div class="section-header">
                    <h2><i class="fa-solid fa-database"></i> Manajemen Data</h2>
                    <i class="fa-solid fa-chevron-down chevron"></i>
                </div>
                <div class="section-content">
                    <div class="button-group">
                        <button id="import-excel" class="btn btn-success"><i class="fa-solid fa-file-excel"></i> Impor Excel</button>
                        <input type="file" id="excel-file-input" accept=".xlsx, .xls" style="display: none;">
                        <button id="download-template" class="btn btn-outline"><i class="fa-solid fa-file-arrow-down"></i> Unduh Template</button>
                        <button id="export-excel" class="btn btn-success"><i class="fa-solid fa-file-export"></i> Ekspor Excel</button>
                        <button id="export-pdf" class="btn btn-danger"><i class="fa-solid fa-file-pdf"></i> Ekspor PDF</button>
                        <button id="export-word" class="btn btn-primary"><i class="fa-solid fa-file-word"></i> Ekspor Word</button>
                        <button id="save-snapshot" class="btn btn-secondary"><i class="fa-solid fa-save"></i> Simpan Snapshot</button>
                        <button id="load-snapshot" class="btn btn-secondary"><i class="fa-solid fa-folder-open"></i> Muat Snapshot</button>
                        <input type="file" id="snapshot-file-input" accept=".json" style="display: none;">
                        <button id="load-dummy" class="btn btn-warning"><i class="fa-solid fa-vial"></i> Data Contoh</button>
                        <button id="reset-data" class="btn btn-danger"><i class="fa-solid fa-trash"></i> Reset Semua Data</button>
                    </div>
                </div>
            </div>
            <!-- Financial Statements Section -->
            <div class="section" id="financial-statements-section">
                <div class="section-header">
                    <h2><i class="fa-solid fa-file-invoice-dollar"></i> Laporan Keuangan</h2>
                    <i class="fa-solid fa-chevron-down chevron"></i>
                </div>
                <div class="section-content" style="display: block;">
                    <h3>Neraca</h3>
                    <div id="balance-sheet-container" class="table-container"></div>
                    <h3 style="margin-top: 20px;">Laporan Laba Rugi</h3>
                    <div id="income-statement-container" class="table-container"></div>
                    <h3 style="margin-top: 20px;">Laporan Arus Kas</h3>
                    <div id="cash-flow-container" class="table-container"></div>
                </div>
            </div>
        </section>

        <!-- Dashboard Tab -->
        <section id="dashboard-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2><i class="fa-solid fa-table-list"></i> Tabel Rasio Keuangan</h2>
                    <i class="fa-solid fa-chevron-down chevron"></i>
                </div>
                <div class="section-content" style="display:block;">
                    <div id="ratio-table-container" class="table-container"></div>
                </div>
            </div>
            <div class="section">
                <div class="section-header">
                    <h2><i class="fa-solid fa-chart-line"></i> Grafik Visualisasi</h2>
                    <div class="button-group">
                        <button id="export-charts" class="btn btn-primary"><i class="fa-solid fa-image"></i> Ekspor Semua Grafik</button>
                    </div>
                </div>
                <div class="section-content dashboard-grid" id="charts-container">
                    <!-- Charts will be rendered here by JS -->
                </div>
            </div>
        </section>

        <!-- Analysis Tab -->
        <section id="analysis-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2><i class="fa-solid fa-brain"></i> Pengaturan AI</h2>
                    <i class="fa-solid fa-chevron-down chevron"></i>
                </div>
                <div class="section-content" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label for="gemini-api-key">Gemini API Key</label>
                        <input type="password" id="gemini-api-key" placeholder="Masukkan API Key Gemini Anda">
                    </div>
                    <div class="form-group">
                        <label for="deepseek-api-key">DeepSeek API Key</label>
                        <input type="password" id="deepseek-api-key" placeholder="Masukkan API Key DeepSeek Anda">
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section-header">
                    <h2><i class="fa-solid fa-magnifying-glass-chart"></i> Ringkasan Kinerja & Analisis</h2>
                    <i class="fa-solid fa-chevron-down chevron"></i>
                </div>
                <div class="section-content" style="display:block;">
                    <div id="analysis-summary"></div>
                    <h3 style="margin-top: 20px; margin-bottom: 10px;">Narasi Analisis</h3>
                    <textarea id="narrative-editor" placeholder="Hasil analisis akan muncul di sini. Anda juga bisa menulis analisis manual."></textarea>
                    <div class="button-group" style="margin-top: 15px;">
                        <button id="generate-narrative" class="btn btn-primary"><i class="fa-solid fa-wand-magic-sparkles"></i> Buat Narasi Otomatis (AI)</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2><i class="fa-solid fa-circle-question"></i> Panduan Penggunaan Aplikasi</h2>
            <p>Selamat datang di Aplikasi Analisis Keuangan Pro! Berikut adalah panduan singkat untuk memulai:</p>
            <ul>
                <li><strong><i class="fa-solid fa-gear"></i> Pengaturan:</strong> Mulai dengan mengatur Tahun Awal, Jumlah Tahun, dan memilih jenis Industri pada tab "Input Data". Klik "Terapkan" untuk membuat tabel. </li>
                <li><strong><i class="fa-solid fa-keyboard"></i> Input Data:</strong> Anda bisa mengisi data keuangan secara manual pada tabel, atau mengimpor dari file Excel menggunakan tombol "Impor Excel". Unduh template terlebih dahulu untuk format yang benar.</li>
                <li><strong><i class="fa-solid fa-database"></i> Manajemen Data:</strong> Gunakan tombol di bagian ini untuk ekspor data ke Excel, PDF, atau Word. Anda juga bisa menyimpan (snapshot) dan memuat kembali sesi kerja Anda.</li>
                <li><strong><i class="fa-solid fa-tachometer-alt"></i> Dashboard:</strong> Setelah data terisi, pindah ke tab Dashboard untuk melihat tabel rasio keuangan (dibandingkan dengan benchmark industri) dan visualisasi grafik interaktif.</li>
                <li><strong><i class="fa-solid fa-pen-to-square"></i> Analisis:</strong> Tab ini memberikan ringkasan kinerja dan memungkinkan Anda membuat narasi analisis secara otomatis menggunakan AI. Masukkan API Key Anda di bagian pengaturan AI.</li>
                <li><strong><i class="fa-solid fa-moon"></i> Mode Gelap/Terang:</strong> Gunakan tombol bulan di sudut kanan atas untuk beralih antara mode terang dan gelap.</li>
            </ul>
        </div>
    </div>
    
    <!-- Spinner/Loading Indicator -->
    <div id="spinner">
        <div class="loader"></div>
    </div>
    
    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script>
        // File asli tidak memiliki logika JavaScript. Kode di bawah ini adalah implementasi lengkap untuk membuat aplikasi berfungsi.

        // =====================================================================
        // Variabel Global dan State Aplikasi
        // =====================================================================

        let appState = {
            startYear: new Date().getFullYear(),
            numYears: 5,
            financialData: {
                balanceSheet: [],
                incomeStatement: [],
                cashFlow: []
            },
            ratios: {},
            industry: 'Umum',
            apiKeys: {
                gemini: '',
                deepseek: ''
            },
            narrative: '',
            benchmarkData: {
                'Umum': {
                    'Rasio Lancar': { min: 1.5, max: 2.5 },
                    'Rasio Cepat': { min: 1.0, max: 1.5 },
                    'Rasio Utang terhadap Ekuitas': { min: 0.5, max: 1.0 },
                    'Margin Laba Kotor': { min: 0.3, max: 0.5 },
                    'Return on Assets (ROA)': { min: 0.05, max: 0.15 },
                    'Return on Equity (ROE)': { min: 0.1, max: 0.2 }
                },
                'Manufaktur': {
                    'Rasio Lancar': { min: 1.2, max: 2.0 },
                    'Rasio Cepat': { min: 0.8, max: 1.2 },
                    'Rasio Utang terhadap Ekuitas': { min: 1.0, max: 1.5 },
                    'Margin Laba Kotor': { min: 0.25, max: 0.4 },
                    'Return on Assets (ROA)': { min: 0.04, max: 0.12 },
                    'Return on Equity (ROE)': { min: 0.08, max: 0.18 }
                },
                'Jasa': {
                    'Rasio Lancar': { min: 2.0, max: 3.0 },
                    'Rasio Cepat': { min: 1.5, max: 2.5 },
                    'Rasio Utang terhadap Ekuitas': { min: 0.3, max: 0.8 },
                    'Margin Laba Kotor': { min: 0.6, max: 0.8 },
                    'Return on Assets (ROA)': { min: 0.08, max: 0.2 },
                    'Return on Equity (ROE)': { min: 0.15, max: 0.3 }
                }
            }
        };

        let activeCharts = []; // Untuk menyimpan instance chart.js agar bisa diupdate/dihancurkan

        // =====================================================================
        // Helper Functions (Fungsi Bantuan)
        // =====================================================================

        /**
         * Menampilkan notifikasi di pojok kanan bawah layar.
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {string} type - Tipe notifikasi (info, success, warning, error).
         */
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fa-solid fa-info-circle"></i> ${message}`;
            container.appendChild(notification);

            // Hilangkan notifikasi setelah 5 detik
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        /**
         * Menampilkan atau menyembunyikan spinner loading.
         * @param {boolean} show - True untuk menampilkan, False untuk menyembunyikan.
         */
        function toggleSpinner(show) {
            document.getElementById('spinner').style.display = show ? 'block' : 'none';
        }

        /**
         * Fungsi debounce untuk menunda eksekusi suatu fungsi.
         * Berguna untuk input agar tidak terlalu sering memicu event.
         * @param {function} func - Fungsi yang akan didebounce.
         * @param {number} delay - Jeda waktu dalam ms.
         */
        function debounce(func, delay) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func(...args), delay);
            };
        }

        /**
         * Mengubah teks menjadi nama file yang aman.
         * @param {string} text - Teks input.
         * @returns {string} - Nama file yang bersih.
         */
        function sanitizeFilename(text) {
            return text.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        }

        /**
         * Mengubah data finansial menjadi format array 2D untuk ekspor.
         * @param {string} statementKey - 'balanceSheet', 'incomeStatement', atau 'cashFlow'.
         * @returns {Array<Array<any>>} - Array data untuk ekspor.
         */
        function prepareDataForExport(statementKey) {
            const tableData = appState.financialData[statementKey];
            if (!tableData || tableData.length === 0) return [];

            const years = Array.from({ length: appState.numYears }, (_, i) => appState.startYear + i);
            const headers = ['Keterangan', ...years];
            const dataRows = tableData.map(row => [row.name, ...row.values]);

            return [headers, ...dataRows];
        }

        /**
         * Memuat data dummy ke state aplikasi.
         */
        function loadDummyData() {
            showNotification('Memuat data contoh...', 'info');

            const dummyData = {
                balanceSheet: [
                    { name: "Kas & Setara Kas", values: [15000, 16500, 18000, 19500, 21000] },
                    { name: "Piutang Usaha", values: [20000, 22000, 24000, 26000, 28000] },
                    { name: "Persediaan", values: [35000, 38000, 40000, 42000, 45000] },
                    { name: "Aset Lancar Lainnya", values: [5000, 5500, 6000, 6500, 7000] },
                    { name: "Total Aset Lancar", values: [75000, 82000, 88000, 94000, 101000] },
                    { name: "Tanah, Bangunan & Peralatan", values: [120000, 125000, 130000, 135000, 140000] },
                    { name: "Akumulasi Penyusutan", values: [-30000, -32000, -34000, -36000, -38000] },
                    { name: "Total Aset Tidak Lancar", values: [90000, 93000, 96000, 99000, 102000] },
                    { name: "Total Aset", values: [165000, 175000, 184000, 193000, 203000] },
                    { name: "Utang Usaha", values: [25000, 27000, 29000, 31000, 33000] },
                    { name: "Utang Jangka Pendek Lainnya", values: [10000, 11000, 12000, 13000, 14000] },
                    { name: "Total Kewajiban Lancar", values: [35000, 38000, 41000, 44000, 47000] },
                    { name: "Utang Jangka Panjang", values: [50000, 48000, 46000, 44000, 42000] },
                    { name: "Total Kewajiban", values: [85000, 86000, 87000, 88000, 89000] },
                    { name: "Modal Saham", values: [50000, 50000, 50000, 50000, 50000] },
                    { name: "Laba Ditahan", values: [30000, 39000, 47000, 55000, 64000] },
                    { name: "Total Ekuitas", values: [80000, 89000, 97000, 105000, 114000] },
                    { name: "Total Kewajiban & Ekuitas", values: [165000, 175000, 184000, 193000, 203000] }
                ],
                incomeStatement: [
                    { name: "Pendapatan Bersih", values: [150000, 160000, 175000, 185000, 200000] },
                    { name: "Harga Pokok Penjualan (HPP)", values: [90000, 96000, 105000, 111000, 120000] },
                    { name: "Laba Kotor", values: [60000, 64000, 70000, 74000, 80000] },
                    { name: "Beban Operasional", values: [30000, 32000, 34000, 36000, 38000] },
                    { name: "Beban Bunga", values: [2000, 1800, 1600, 1400, 1200] },
                    { name: "Laba Sebelum Pajak", values: [28000, 30200, 34400, 36600, 40800] },
                    { name: "Beban Pajak", values: [5600, 6040, 6880, 7320, 8160] },
                    { name: "Laba Bersih", values: [22400, 24160, 27520, 29280, 32640] }
                ],
                cashFlow: [
                    { name: "Laba Bersih", values: [22400, 24160, 27520, 29280, 32640] },
                    { name: "Depresiasi", values: [5000, 5000, 5000, 5000, 5000] },
                    { name: "Perubahan Modal Kerja", values: [2000, -500, 1000, -200, 800] },
                    { name: "Kas dari Operasi", values: [29400, 28660, 33520, 34080, 38440] },
                    { name: "Pengeluaran Modal (CapEx)", values: [-10000, -10000, -10000, -10000, -10000] },
                    { name: "Kas dari Investasi", values: [-10000, -10000, -10000, -10000, -10000] },
                    { name: "Penerbitan Utang", values: [5000, -2000, -2000, -2000, -2000] },
                    { name: "Pembayaran Dividen", values: [-2000, -2000, -2000, -2000, -2000] },
                    { name: "Kas dari Pendanaan", values: [3000, -4000, -4000, -4000, -4000] },
                    { name: "Perubahan Bersih Kas", values: [22400, 14660, 19520, 20080, 24440] }
                ]
            };

            appState.financialData = dummyData;
            saveState();
            renderAll();
            showNotification('Data contoh berhasil dimuat.', 'success');
        }

        // =====================================================================
        // Core Functions (Fungsi Utama)
        // =====================================================================

        /**
         * Mengatur tab yang aktif berdasarkan ID.
         * @param {string} tabId - ID tab yang akan diaktifkan.
         */
        function showTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            const navButtons = document.querySelectorAll('nav button');
            const modal = document.getElementById('help-modal');

            // Sembunyikan semua tab dan modal
            tabs.forEach(tab => tab.classList.remove('active'));
            navButtons.forEach(btn => btn.classList.remove('active'));
            modal.style.display = 'none';

            if (tabId === 'help-modal') {
                modal.style.display = 'block';
            } else {
                // Tampilkan tab yang dipilih
                const activeTab = document.getElementById(tabId);
                const activeNavButton = document.querySelector(`nav button[data-tab="${tabId}"]`);
                if (activeTab) activeTab.classList.add('active');
                if (activeNavButton) activeNavButton.classList.add('active');

                // Render ulang chart ketika pindah ke dashboard
                if (tabId === 'dashboard-tab') {
                    renderCharts();
                }
            }
        }

        /**
         * Mengatur logika untuk collapsible sections.
         */
        function setupCollapsibleSections() {
            const headers = document.querySelectorAll('.section-header');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const section = header.closest('.section');
                    section.classList.toggle('collapsed');
                });
            });
        }

        /**
         * Membuat tabel laporan keuangan secara dinamis.
         * @param {string} tableId - ID elemen div untuk tabel.
         * @param {string} statementKey - Kunci data di appState.financialData.
         * @param {boolean} isBalanceSheet - Menandai apakah ini neraca untuk pengecekan total.
         */
        function createFinancialTable(tableId, statementKey, isBalanceSheet = false) {
            const container = document.getElementById(tableId);
            const tableData = appState.financialData[statementKey];
            const numYears = appState.numYears;
            const startYear = appState.startYear;

            if (!container || !tableData) return;

            // Buat header tabel
            let tableHTML = '<table><thead><tr><th>Keterangan</th>';
            for (let i = 0; i < numYears; i++) {
                tableHTML += `<th>${startYear + i}</th>`;
            }
            tableHTML += '</tr></thead><tbody>';

            // Buat baris data
            tableData.forEach((row, rowIndex) => {
                let isTotalRow = row.name.startsWith('Total');
                let rowClass = isTotalRow ? 'total-row' : '';
                tableHTML += `<tr class="${rowClass}"><td>${row.name}</td>`;
                for (let i = 0; i < numYears; i++) {
                    const value = row.values[i] || '';
                    tableHTML += `<td><input type="text" data-row="${rowIndex}" data-col="${i}" value="${value}"></td>`;
                }
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        /**
         * Memeriksa dan memperbarui status error pada neraca.
         */
        function checkBalanceSheet() {
            const totalAssetsRows = appState.financialData.balanceSheet.filter(row => row.name === 'Total Aset');
            const totalLiabilitiesEquityRows = appState.financialData.balanceSheet.filter(row => row.name === 'Total Kewajiban & Ekuitas');
            
            const totalAssetRowElement = document.querySelector('#balance-sheet-container tr.total-row:nth-child(9)');
            const totalLiabEquityRowElement = document.querySelector('#balance-sheet-container tr.total-row:last-child');
            
            if (totalAssetsRows.length === 0 || totalLiabilitiesEquityRows.length === 0 || !totalAssetRowElement || !totalLiabEquityRowElement) return;

            for (let i = 0; i < appState.numYears; i++) {
                const totalAssets = totalAssetsRows[0].values[i] || 0;
                const totalLiabEquity = totalLiabilitiesEquityRows[0].values[i] || 0;

                const assetCell = totalAssetRowElement.querySelector(`td:nth-child(${i + 2})`);
                const liabEquityCell = totalLiabEquityRowElement.querySelector(`td:nth-child(${i + 2})`);

                if (Math.abs(totalAssets - totalLiabEquity) > 1) { // Toleransi kecil
                    assetCell.classList.add('error-cell');
                    liabEquityCell.classList.add('error-cell');
                    showNotification(`Neraca tidak seimbang di tahun ${appState.startYear + i}!`, 'warning');
                } else {
                    assetCell.classList.remove('error-cell');
                    liabEquityCell.classList.remove('error-cell');
                }
            }
        }

        /**
         * Merender semua laporan keuangan.
         */
        function renderFinancialStatements() {
            createFinancialTable('balance-sheet-container', 'balanceSheet', true);
            createFinancialTable('income-statement-container', 'incomeStatement');
            createFinancialTable('cash-flow-container', 'cashFlow');
            checkBalanceSheet();
        }

        /**
         * Menangani perubahan input tabel dengan debounce.
         */
        const debouncedInputChange = debounce((e) => {
            const input = e.target;
            const rowIndex = input.dataset.row;
            const colIndex = input.dataset.col;
            const tableId = input.closest('.table-container').id;
            const statementKey = tableId.replace('-container', '');

            const value = parseFloat(input.value.replace(/[^0-9.-]/g, ''));
            if (!isNaN(value)) {
                appState.financialData[statementKey][rowIndex].values[colIndex] = value;
            } else {
                appState.financialData[statementKey][rowIndex].values[colIndex] = 0;
            }

            saveState();
            renderAll();
        }, 500);

        /**
         * Menerapkan pengaturan tahun dan jumlah tahun.
         */
        function applySettings() {
            const startYearInput = document.getElementById('start-year');
            const numYearsInput = document.getElementById('num-years');

            const newStartYear = parseInt(startYearInput.value);
            const newNumYears = parseInt(numYearsInput.value);

            if (isNaN(newStartYear) || isNaN(newNumYears) || newNumYears < 1 || newNumYears > 10) {
                showNotification('Input tahun tidak valid!', 'error');
                return;
            }

            appState.startYear = newStartYear;
            appState.numYears = newNumYears;

            // Reset data laporan keuangan
            appState.financialData = {
                balanceSheet: appState.financialData.balanceSheet.map(row => ({ name: row.name, values: Array(newNumYears).fill(0) })),
                incomeStatement: appState.financialData.incomeStatement.map(row => ({ name: row.name, values: Array(newNumYears).fill(0) })),
                cashFlow: appState.financialData.cashFlow.map(row => ({ name: row.name, values: Array(newNumYears).fill(0) }))
            };

            saveState();
            renderFinancialStatements();
            showNotification('Pengaturan berhasil diterapkan.', 'success');
        }

        /**
         * Mengosongkan semua data dalam aplikasi.
         */
        function resetData() {
            if (confirm('Apakah Anda yakin ingin mereset semua data?')) {
                appState.financialData = {
                    balanceSheet: [],
                    incomeStatement: [],
                    cashFlow: []
                };
                appState.ratios = {};
                appState.narrative = '';
                document.getElementById('start-year').value = new Date().getFullYear();
                document.getElementById('num-years').value = 5;

                saveState();
                init();
                showNotification('Semua data berhasil direset.', 'success');
            }
        }

        /**
         * Menyimpan state aplikasi ke Local Storage.
         */
        function saveState() {
            localStorage.setItem('appState', JSON.stringify(appState));
        }

        /**
         * Memuat state aplikasi dari Local Storage.
         */
        function loadState() {
            const savedState = localStorage.getItem('appState');
            if (savedState) {
                appState = JSON.parse(savedState);
                showNotification('State aplikasi berhasil dimuat dari penyimpanan lokal.', 'success');
            }
        }
        
        /**
         * Mengunduh file blob.
         * @param {Blob} blob - Blob yang akan diunduh.
         * @param {string} filename - Nama file.
         */
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // =====================================================================
        // Data Analysis & Ratios (Analisis Data & Rasio)
        // =====================================================================

        /**
         * Menghitung semua rasio keuangan dari data yang ada.
         */
        function calculateRatios() {
            const ratios = {};
            const bs = appState.financialData.balanceSheet;
            const is = appState.financialData.incomeStatement;

            if (bs.length === 0 || is.length === 0) {
                appState.ratios = {};
                return;
            }

            const totalAssets = bs.find(row => row.name === 'Total Aset')?.values || Array(appState.numYears).fill(0);
            const currentAssets = bs.find(row => row.name === 'Total Aset Lancar')?.values || Array(appState.numYears).fill(0);
            const currentLiabilities = bs.find(row => row.name === 'Total Kewajiban Lancar')?.values || Array(appState.numYears).fill(0);
            const cash = bs.find(row => row.name === 'Kas & Setara Kas')?.values || Array(appState.numYears).fill(0);
            const inventory = bs.find(row => row.name === 'Persediaan')?.values || Array(appState.numYears).fill(0);
            const totalLiabilities = bs.find(row => row.name === 'Total Kewajiban')?.values || Array(appState.numYears).fill(0);
            const totalEquity = bs.find(row => row.name === 'Total Ekuitas')?.values || Array(appState.numYears).fill(0);
            const netIncome = is.find(row => row.name === 'Laba Bersih')?.values || Array(appState.numYears).fill(0);
            const grossProfit = is.find(row => row.name === 'Laba Kotor')?.values || Array(appState.numYears).fill(0);
            const revenue = is.find(row => row.name === 'Pendapatan Bersih')?.values || Array(appState.numYears).fill(0);

            ratios['Rasio Lancar'] = currentAssets.map((val, i) => (currentLiabilities[i] !== 0 ? (val / currentLiabilities[i]) : 0).toFixed(2));
            ratios['Rasio Cepat'] = currentAssets.map((val, i) => (currentLiabilities[i] !== 0 ? ((val - inventory[i]) / currentLiabilities[i]) : 0).toFixed(2));
            ratios['Rasio Utang terhadap Ekuitas'] = totalLiabilities.map((val, i) => (totalEquity[i] !== 0 ? (val / totalEquity[i]) : 0).toFixed(2));
            ratios['Margin Laba Kotor'] = grossProfit.map((val, i) => (revenue[i] !== 0 ? (val / revenue[i]) : 0).toFixed(2));
            ratios['Return on Assets (ROA)'] = netIncome.map((val, i) => (totalAssets[i] !== 0 ? (val / totalAssets[i]) : 0).toFixed(2));
            ratios['Return on Equity (ROE)'] = netIncome.map((val, i) => (totalEquity[i] !== 0 ? (val / totalEquity[i]) : 0).toFixed(2));

            appState.ratios = ratios;
        }

        /**
         * Merender tabel rasio keuangan.
         */
        function renderRatioTable() {
            const container = document.getElementById('ratio-table-container');
            const years = Array.from({ length: appState.numYears }, (_, i) => appState.startYear + i);
            const ratios = appState.ratios;
            const industry = appState.industry;
            const benchmark = appState.benchmarkData[industry] || appState.benchmarkData['Umum'];

            if (Object.keys(ratios).length === 0 || !container) {
                container.innerHTML = '<p>Data tidak tersedia untuk menghitung rasio.</p>';
                return;
            }

            let tableHTML = '<table><thead><tr><th>Rasio Keuangan</th>';
            years.forEach(year => tableHTML += `<th>${year}</th>`);
            tableHTML += `<th>Benchmark (${industry})</th></tr></thead><tbody>`;

            for (const ratioName in ratios) {
                tableHTML += '<tr>';
                tableHTML += `<td>${ratioName}</td>`;
                const ratioValues = ratios[ratioName];
                const benchmarkRange = benchmark[ratioName];

                for (let i = 0; i < ratioValues.length; i++) {
                    const value = parseFloat(ratioValues[i]);
                    let cellClass = '';
                    if (benchmarkRange && value >= benchmarkRange.min && value <= benchmarkRange.max) {
                        cellClass = 'ratio-good';
                    } else if (benchmarkRange) {
                        cellClass = 'ratio-bad';
                    }
                    tableHTML += `<td class="${cellClass}">${value}</td>`;
                }

                if (benchmarkRange) {
                    tableHTML += `<td>${benchmarkRange.min} - ${benchmarkRange.max}</td>`;
                } else {
                    tableHTML += `<td>-</td>`;
                }
                tableHTML += '</tr>';
            }

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }


        // =====================================================================
        // Charting Functions (Fungsi untuk Grafik)
        // =====================================================================

        /**
         * Membuat Chart.js baru dalam elemen canvas.
         * @param {string} canvasId - ID elemen canvas.
         * @param {string} title - Judul grafik.
         * @param {Array<string>} labels - Label sumbu X.
         * @param {Array<object>} datasets - Dataset untuk grafik.
         * @returns {Chart} - Instance chart.js.
         */
        function createChart(canvasId, title, labels, datasets) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: title }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        }

        /**
         * Merender semua grafik ke dashboard.
         */
        function renderCharts() {
            // Hancurkan chart yang sudah ada
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
            const container = document.getElementById('charts-container');
            container.innerHTML = '';

            const ratios = appState.ratios;
            if (Object.keys(ratios).length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 mt-4">Tidak ada data rasio untuk divisualisasikan.</p>';
                return;
            }

            const years = Array.from({ length: appState.numYears }, (_, i) => (appState.startYear + i).toString());

            for (const ratioName in ratios) {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.innerHTML = `<h3>${ratioName}</h3><canvas id="chart-${sanitizeFilename(ratioName)}"></canvas>`;
                container.appendChild(chartContainer);

                const data = ratios[ratioName].map(val => parseFloat(val));
                const datasets = [{
                    label: ratioName,
                    data: data,
                    borderColor: appState.benchmarkData[appState.industry]?.[ratioName] ? '#0d6efd' : '#6c757d',
                    tension: 0.1,
                    fill: false
                }];
                
                // Tambahkan benchmark sebagai garis horizontal jika ada
                if (appState.benchmarkData[appState.industry]?.[ratioName]) {
                    const { min, max } = appState.benchmarkData[appState.industry][ratioName];
                    datasets.push({
                        label: `Min Benchmark (${min})`,
                        data: Array(appState.numYears).fill(min),
                        borderColor: '#198754',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    });
                    datasets.push({
                        label: `Max Benchmark (${max})`,
                        data: Array(appState.numYears).fill(max),
                        borderColor: '#dc3545',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    });
                }


                const chart = createChart(`chart-${sanitizeFilename(ratioName)}`, ratioName, years, datasets);
                activeCharts.push(chart);
            }
        }
        
        /**
         * Mengekspor semua chart sebagai satu gambar.
         */
        function exportAllCharts() {
            if (activeCharts.length === 0) {
                showNotification('Tidak ada grafik untuk diekspor.', 'warning');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const totalHeight = activeCharts.reduce((sum, chart) => sum + chart.height, 0) + (activeCharts.length - 1) * 20;
            const maxWidth = Math.max(...activeCharts.map(chart => chart.width));

            canvas.width = maxWidth;
            canvas.height = totalHeight;
            ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let currentY = 0;
            activeCharts.forEach(chart => {
                ctx.drawImage(chart.canvas, 0, currentY);
                currentY += chart.height + 20;
            });

            const link = document.createElement('a');
            link.download = `Analisis-Keuangan-Grafik-${appState.startYear}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showNotification('Grafik berhasil diekspor.', 'success');
        }


        // =====================================================================
        // Import/Export Functions (Fungsi Impor/Ekspor)
        // =====================================================================

        /**
         * Mengimpor data dari file Excel.
         */
        function importExcel() {
            const fileInput = document.getElementById('excel-file-input');
            fileInput.click();

            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const sheets = {};
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        sheets[sheetName] = json;
                    });
                    
                    try {
                        const bsData = sheets['Neraca'].slice(1).map(row => ({ name: row[0], values: row.slice(1).map(val => parseFloat(val) || 0) }));
                        const isData = sheets['Laba Rugi'].slice(1).map(row => ({ name: row[0], values: row.slice(1).map(val => parseFloat(val) || 0) }));
                        const cfData = sheets['Arus Kas'].slice(1).map(row => ({ name: row[0], values: row.slice(1).map(val => parseFloat(val) || 0) }));
                        
                        const years = sheets['Neraca'][0].slice(1);
                        appState.startYear = parseInt(years[0]);
                        appState.numYears = years.length;
                        
                        appState.financialData.balanceSheet = bsData;
                        appState.financialData.incomeStatement = isData;
                        appState.financialData.cashFlow = cfData;
                        
                        document.getElementById('start-year').value = appState.startYear;
                        document.getElementById('num-years').value = appState.numYears;

                        saveState();
                        renderAll();
                        showNotification('Data Excel berhasil diimpor!', 'success');
                    } catch (error) {
                        console.error('Error saat membaca Excel:', error);
                        showNotification('Gagal mengimpor Excel. Pastikan format file benar.', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
        }

        /**
         * Mengunduh template Excel kosong.
         */
        function downloadExcelTemplate() {
            const templateData = {
                'Neraca': [['Keterangan', 'Tahun 1', 'Tahun 2'], ['Kas & Setara Kas', 0, 0]],
                'Laba Rugi': [['Keterangan', 'Tahun 1', 'Tahun 2'], ['Pendapatan Bersih', 0, 0]],
                'Arus Kas': [['Keterangan', 'Tahun 1', 'Tahun 2'], ['Laba Bersih', 0, 0]]
            };
            
            const workbook = XLSX.utils.book_new();
            for(const sheetName in templateData) {
                const worksheet = XLSX.utils.aoa_to_sheet(templateData[sheetName]);
                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
            }
            
            XLSX.writeFile(workbook, 'Template-Analisis-Keuangan.xlsx');
            showNotification('Template Excel berhasil diunduh.', 'success');
        }

        /**
         * Mengekspor data ke file Excel.
         */
        function exportToExcel() {
            const workbook = XLSX.utils.book_new();
            const years = Array.from({ length: appState.numYears }, (_, i) => appState.startYear + i);
            
            // Neraca
            const balanceSheetData = prepareDataForExport('balanceSheet');
            const ws_bs = XLSX.utils.aoa_to_sheet(balanceSheetData);
            XLSX.utils.book_append_sheet(workbook, ws_bs, 'Neraca');

            // Laporan Laba Rugi
            const incomeStatementData = prepareDataForExport('incomeStatement');
            const ws_is = XLSX.utils.aoa_to_sheet(incomeStatementData);
            XLSX.utils.book_append_sheet(workbook, ws_is, 'Laba Rugi');

            // Laporan Arus Kas
            const cashFlowData = prepareDataForExport('cashFlow');
            const ws_cf = XLSX.utils.aoa_to_sheet(cashFlowData);
            XLSX.utils.book_append_sheet(workbook, ws_cf, 'Arus Kas');

            XLSX.writeFile(workbook, `Analisis-Keuangan-${appState.startYear}.xlsx`);
            showNotification('Data berhasil diekspor ke Excel.', 'success');
        }

        /**
         * Mengekspor data ke file PDF.
         */
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const tablesToExport = [
                { title: 'Neraca', data: prepareDataForExport('balanceSheet') },
                { title: 'Laporan Laba Rugi', data: prepareDataForExport('incomeStatement') },
                { title: 'Laporan Arus Kas', data: prepareDataForExport('cashFlow') },
                { title: 'Tabel Rasio Keuangan', data: [
                    ['Rasio Keuangan', ...Object.keys(appState.ratios).map(r => r)],
                    ...Object.values(appState.ratios).map((values, i) => [
                        Object.keys(appState.ratios)[i],
                        ...values
                    ])
                ]}
            ];
            
            let y = 20;
            tablesToExport.forEach(table => {
                if (table.data.length > 1) {
                    doc.setFontSize(14);
                    doc.text(table.title, 14, y);
                    doc.autoTable({
                        startY: y + 5,
                        head: [table.data[0]],
                        body: table.data.slice(1),
                        theme: 'grid',
                        styles: { fontSize: 8 },
                    });
                    y = doc.autoTable.previous.finalY + 10;
                }
            });

            doc.save(`Analisis-Keuangan-${appState.startYear}.pdf`);
            showNotification('Data berhasil diekspor ke PDF.', 'success');
        }
        
        /**
         * Mengekspor data ke file Word.
         */
        function exportToWord() {
            const docxtemplater = new window.docxtemplater();
            const PizZip = window.PizZip;

            const zip = new PizZip();
            zip.file('word/document.xml', '<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:body><w:p><w:r><w:t>Template Word</w:t></w:r></w:p></w:body></w:document>');

            const data = {
                title: 'Laporan Analisis Keuangan',
                date: new Date().toLocaleDateString('id-ID'),
                startYear: appState.startYear,
                endYear: appState.startYear + appState.numYears - 1,
                tables: [
                    {
                        name: 'Neraca',
                        headers: ['Keterangan', ...Array.from({ length: appState.numYears }, (_, i) => appState.startYear + i)],
                        rows: appState.financialData.balanceSheet.map(row => ({
                            name: row.name,
                            values: row.values
                        }))
                    },
                    {
                        name: 'Laporan Laba Rugi',
                        headers: ['Keterangan', ...Array.from({ length: appState.numYears }, (_, i) => appState.startYear + i)],
                        rows: appState.financialData.incomeStatement.map(row => ({
                            name: row.name,
                            values: row.values
                        }))
                    },
                    {
                        name: 'Laporan Arus Kas',
                        headers: ['Keterangan', ...Array.from({ length: appState.numYears }, (_, i) => appState.startYear + i)],
                        rows: appState.financialData.cashFlow.map(row => ({
                            name: row.name,
                            values: row.values
                        }))
                    }
                ],
                ratios: Object.keys(appState.ratios).map(ratioName => ({
                    name: ratioName,
                    years: Object.values(appState.ratios[ratioName]).map(val => val)
                }))
            };
            
            // docxtemplater memerlukan template yang sudah ada.
            // Tanpa file template, kita hanya bisa membuat dokumen sederhana.
            // Untuk demo, kita akan membuat dokumen sederhana dengan teks.
            docxtemplater.loadZip(zip);
            docxtemplater.setData(data);

            try {
                docxtemplater.render();
                const out = docxtemplater.getZip().generate({ type: 'blob', mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                downloadBlob(out, `Analisis-Keuangan-${appState.startYear}.docx`);
                showNotification('Data berhasil diekspor ke Word. Catatan: Ini adalah file sederhana karena template tidak disediakan.', 'warning');
            } catch (error) {
                console.error('Error saat membuat Word:', error);
                showNotification('Gagal mengekspor ke Word. Kesalahan: ' + error.message, 'error');
            }
        }

        /**
         * Menyimpan state aplikasi ke file JSON.
         */
        function saveSnapshot() {
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            downloadBlob(blob, `snapshot-analisis-${appState.startYear}.json`);
            showNotification('Snapshot berhasil disimpan.', 'success');
        }

        /**
         * Memuat state aplikasi dari file JSON.
         */
        function loadSnapshot() {
            const fileInput = document.getElementById('snapshot-file-input');
            fileInput.click();

            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedState = JSON.parse(event.target.result);
                        appState = { ...appState, ...loadedState }; // Gabungkan state
                        document.getElementById('start-year').value = appState.startYear;
                        document.getElementById('num-years').value = appState.numYears;
                        document.getElementById('gemini-api-key').value = appState.apiKeys.gemini || '';
                        document.getElementById('deepseek-api-key').value = appState.apiKeys.deepseek || '';
                        document.getElementById('narrative-editor').value = appState.narrative || '';
                        
                        saveState();
                        renderAll();
                        showNotification('Snapshot berhasil dimuat.', 'success');
                    } catch (error) {
                        console.error('Error saat membaca file snapshot:', error);
                        showNotification('Gagal memuat snapshot. Pastikan format file benar.', 'error');
                    }
                };
                reader.readAsText(file);
            };
        }


        // =====================================================================
        // AI Analysis Functions (Fungsi Analisis AI)
        // =====================================================================

        /**
         * Memformat data laporan keuangan ke dalam string teks yang terstruktur.
         * @returns {string} - Data laporan keuangan dalam format Markdown.
         */
        function formatFinancialDataForAI() {
            const years = Array.from({ length: appState.numYears }, (_, i) => appState.startYear + i);
            let text = 'Laporan Keuangan Tahunan:\n\n';

            const formatTable = (title, data) => {
                text += `### ${title}\n`;
                text += `| Keterangan | ${years.join(' | ')} |\n`;
                text += `|---|${'---|'.repeat(years.length)}\n`;
                data.forEach(row => {
                    const values = row.values.map(val => (val !== undefined && val !== null) ? val.toLocaleString('id-ID') : '-');
                    text += `| ${row.name} | ${values.join(' | ')} |\n`;
                });
                text += '\n';
            };

            formatTable('Neraca', appState.financialData.balanceSheet);
            formatTable('Laporan Laba Rugi', appState.financialData.incomeStatement);
            formatTable('Laporan Arus Kas', appState.financialData.cashFlow);

            text += '### Rasio Keuangan\n';
            text += `| Rasio | ${years.join(' | ')} |\n`;
            text += `|---|${'---|'.repeat(years.length)}\n`;
            for (const ratioName in appState.ratios) {
                const values = appState.ratios[ratioName].map(val => (val !== undefined && val !== null) ? parseFloat(val).toLocaleString('id-ID') : '-');
                text += `| ${ratioName} | ${values.join(' | ')} |\n`;
            }
            text += '\n';

            return text;
        }

        /**
         * Menghasilkan narasi analisis otomatis menggunakan Gemini API.
         */
        async function generateAiAnalysis() {
            const geminiApiKey = document.getElementById('gemini-api-key').value;
            if (!geminiApiKey) {
                showNotification('Harap masukkan Gemini API Key Anda.', 'warning');
                return;
            }

            if (Object.keys(appState.ratios).length === 0) {
                showNotification('Data tidak memadai untuk analisis. Harap isi data laporan keuangan terlebih dahulu.', 'warning');
                return;
            }

            toggleSpinner(true);

            try {
                const financialDataText = formatFinancialDataForAI();
                const prompt = `Anda adalah seorang analis keuangan ahli. Berdasarkan data laporan keuangan dan rasio berikut, berikan narasi analisis yang mendalam tentang kinerja perusahaan selama periode tersebut. Soroti tren utama, kekuatan, kelemahan, dan berikan kesimpulan. Gunakan Bahasa Indonesia yang profesional dan mudah dipahami. \n\nData:\n\n${financialDataText}`;
                
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = geminiApiKey; // Gunakan API key dari input pengguna
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Gagal terhubung ke API Gemini.');
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    document.getElementById('narrative-editor').value = text;
                    appState.narrative = text;
                    saveState();
                    showNotification('Narasi analisis berhasil dibuat!', 'success');
                } else {
                    throw new Error('Respons API tidak valid atau kosong.');
                }

            } catch (error) {
                console.error('Error saat memanggil API Gemini:', error);
                showNotification(`Gagal membuat narasi AI. Error: ${error.message}`, 'error');
            } finally {
                toggleSpinner(false);
            }
        }
        
        /**
         * Memperbarui ringkasan kinerja berdasarkan rasio yang dihitung.
         */
        function updateAnalysisSummary() {
            const container = document.getElementById('analysis-summary');
            container.innerHTML = '';
            
            const ratios = appState.ratios;
            if (Object.keys(ratios).length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Tidak ada ringkasan kinerja. Isi data untuk menghitung rasio.</p>';
                return;
            }

            const years = Array.from({ length: appState.numYears }, (_, i) => appState.startYear + i);
            const latestYearIndex = years.length - 1;

            for (const ratioName in ratios) {
                const values = ratios[ratioName];
                const latestValue = parseFloat(values[latestYearIndex]);
                const prevValue = parseFloat(values[latestYearIndex - 1]);
                let trendIcon = '';
                let trendClass = '';

                if (latestValue > prevValue) {
                    trendIcon = '<i class="fa-solid fa-arrow-trend-up trend-up"></i>';
                    trendClass = 'trend-up';
                } else if (latestValue < prevValue) {
                    trendIcon = '<i class="fa-solid fa-arrow-trend-down trend-down"></i>';
                    trendClass = 'trend-down';
                }

                const summaryCard = document.createElement('div');
                summaryCard.className = 'summary-card';
                summaryCard.innerHTML = `
                    <h4>${ratioName}</h4>
                    <p>${latestValue.toLocaleString('id-ID', { minimumFractionDigits: 2 })} ${trendIcon}</p>
                `;
                container.appendChild(summaryCard);
            }
        }


        // =====================================================================
        // Initializer and Event Listeners (Inisialisasi & Event Listener)
        // =====================================================================
        
        /**
         * Fungsi untuk merender ulang semua komponen yang dinamis.
         */
        function renderAll() {
            renderFinancialStatements();
            calculateRatios();
            renderRatioTable();
            renderCharts();
            updateAnalysisSummary();
        }

        /**
         * Fungsi utama untuk inisialisasi aplikasi.
         */
        function init() {
            // Muat state dari Local Storage
            loadState();
            
            // Isi dropdown industri
            const industrySelect = document.getElementById('industry-select');
            for (const industry in appState.benchmarkData) {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                industrySelect.appendChild(option);
            }
            industrySelect.value = appState.industry;
            
            // Isi nilai input dari state
            document.getElementById('start-year').value = appState.startYear;
            document.getElementById('num-years').value = appState.numYears;
            document.getElementById('gemini-api-key').value = appState.apiKeys.gemini || '';
            document.getElementById('deepseek-api-key').value = appState.apiKeys.deepseek || '';
            document.getElementById('narrative-editor').value = appState.narrative || '';
            
            // Render komponen awal
            renderAll();
            setupCollapsibleSections();
            
            // Event Listeners (Sesuai dengan file asli)
            
            // Navigasi
            document.querySelectorAll('nav button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    showTab(tabId);
                });
            });

            // Theme Toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                const icon = document.querySelector('#theme-toggle i');
                icon.className = `fa-solid ${isDarkMode ? 'fa-sun' : 'fa-moon'}`;
            });
            
            // Terapkan tema dari localStorage saat memuat
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('#theme-toggle i').className = 'fa-solid fa-sun';
            }

            // Modal
            document.querySelector('.modal-close').addEventListener('click', () => {
                document.getElementById('help-modal').style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target == document.getElementById('help-modal')) {
                    document.getElementById('help-modal').style.display = 'none';
                }
            });

            // Input Tab Listeners
            document.getElementById('apply-settings').addEventListener('click', applySettings);
            document.getElementById('industry-select').addEventListener('change', (e) => {
                appState.industry = e.target.value;
                saveState();
                renderRatioTable();
                renderCharts(); // Update charts with new benchmarks
            });
            
            // Data Management Listeners
            document.getElementById('import-excel').addEventListener('click', importExcel);
            document.getElementById('download-template').addEventListener('click', downloadExcelTemplate);
            document.getElementById('export-excel').addEventListener('click', exportToExcel);
            document.getElementById('export-pdf').addEventListener('click', exportToPDF);
            document.getElementById('export-word').addEventListener('click', exportToWord);
            document.getElementById('save-snapshot').addEventListener('click', saveSnapshot);
            document.getElementById('load-snapshot').addEventListener('click', loadSnapshot);
            document.getElementById('load-dummy').addEventListener('click', loadDummyData);
            document.getElementById('reset-data').addEventListener('click', resetData);
            document.getElementById('export-charts').addEventListener('click', exportAllCharts);

            // Table input listener (delegated)
            document.getElementById('input-tab').addEventListener('input', (e) => {
                if (e.target.matches('td input[type="text"]')) {
                    debouncedInputChange(e);
                }
            });

            // Analysis tab listeners
            document.getElementById('generate-narrative').addEventListener('click', generateAiAnalysis);
            document.getElementById('gemini-api-key').addEventListener('change', (e) => {
                appState.apiKeys.gemini = e.target.value;
                saveState();
            });
            document.getElementById('deepseek-api-key').addEventListener('change', (e) => {
                appState.apiKeys.deepseek = e.target.value;
                saveState();
            });
            document.getElementById('narrative-editor').addEventListener('input', debounce((e) => {
                appState.narrative = e.target.value;
                saveState();
            }, 500));
        }

        // Run on DOM content loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
